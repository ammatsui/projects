<!DOCTYPE html>
<html>
<head>
    <title>Project Roadmap Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: #333; }
        #sidebar { width: 320px; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: #f4f7f6; }
        #cy { flex-grow: 1; height: 100%; background: #ffffff; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-add { background: #28a745; color: white; }
        .btn-clear { background: #6c757d; color: white; margin-top: 20px; width: 100%; }
        .btn-delete-node { background: #dc3545; color: white; display: none; } /* Hidden until node selected */
        
        .editing-hint { font-size: 0.8em; color: #007bff; margin-bottom: 10px; display: none; }
        .legend { margin-top: 20px; font-size: 0.8em; border-top: 1px solid #ddd; padding-top: 10px; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; border: 1px solid #999; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 id="formTitle">Add Project</h2>
    <div id="editHint" class="editing-hint">âš¡ Editing mode active</div>
    
    <div class="input-group">
        <label>Project Name (ID)</label>
        <input type="text" id="projName" placeholder="e.g. MyProject">
    </div>
    
    <div class="input-group">
        <label>Description</label>
        <textarea id="projDesc" rows="2"></textarea>
    </div>

    <div class="input-group">
        <label>Status</label>
        <select id="projStatus">
            <option value="not-started">Haven't Started</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
        </select>
    </div>

    <div class="input-group">
        <label>Requires (Dependency)</label>
        <input type="text" id="projParent" placeholder="Parent name...">
    </div>

    <div class="btn-group">
        <button class="btn-add" onclick="saveProject()">Save Changes</button>
        <button id="deleteBtn" class="btn-delete-node" onclick="deleteSelectedNode()">Delete Project</button>
    </div>

    <div class="legend">
        <p><span class="dot" style="background: #fff;"></span> Not Started</p>
        <p><span class="dot" style="background: #ffeb3b;"></span> In Progress</p>
        <p><span class="dot" style="background: #4caf50;"></span> Completed</p>
        <hr>
        <small>Tip: Click any circle in the graph to edit its details.</small>
    </div>

    <button class="btn-clear" onclick="clearAll()">Reset Entire Graph</button>
</div>

<div id="cy"></div>

<script>
    let selectedNodeId = null;

    let cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { selector: 'node', style: { 'label': 'data(id)', 'text-valign': 'center', 'text-halign': 'center', 'width': 80, 'height': 80, 'background-color': '#fff', 'border-width': 2, 'border-color': '#666' } },
            { selector: 'node[status="in-progress"]', style: { 'background-color': '#ffeb3b' } },
            { selector: 'node[status="completed"]', style: { 'background-color': '#4caf50', 'color': '#fff' } },
            { selector: 'edge', style: { 'width': 2, 'line-color': '#999', 'target-arrow-shape': 'triangle', 'curve-style': 'straight' } },
            { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#007bff' } }
        ],
        layout: { name: 'breadthfirst', directed: true }
    });

    // Load Data
    const saved = localStorage.getItem('projectGraphV3');
    if (saved) { cy.add(JSON.parse(saved)); runLayout(); }

    function runLayout() { cy.layout({ name: 'breadthfirst', directed: true, spacingFactor: 1.2 }).run(); }

    // CLICK HANDLER: Populate sidebar for editing
    cy.on('tap', 'node', function(evt){
        const node = evt.target;
        selectedNodeId = node.id();
        
        // Fill form fields with existing data
        document.getElementById('projName').value = node.id();
        document.getElementById('projDesc').value = node.data('description') || '';
        document.getElementById('projStatus').value = node.data('status') || 'not-started';
        
        // Find if it has a parent (incoming edge)
        const incoming = node.incomers('edge');
        document.getElementById('projParent').value = incoming.length > 0 ? incoming[0].source().id() : '';

        // UI Updates
        document.getElementById('formTitle').innerText = "Edit Project";
        document.getElementById('editHint').style.display = "block";
        document.getElementById('deleteBtn').style.display = "block";
        document.getElementById('projName').disabled = true; // Don't rename ID to avoid breaking links
    });

    // Deselect handler
    cy.on('tap', function(evt){
        if(evt.target === cy){
            resetForm();
        }
    });

    function saveProject() {
        const name = document.getElementById('projName').value.trim();
        const desc = document.getElementById('projDesc').value;
        const status = document.getElementById('projStatus').value;
        const parent = document.getElementById('projParent').value.trim();

        if (!name) return;

        let node = cy.getElementById(name);
        
        if (node.length > 0) {
            // Edit existing
            node.data('description', desc);
            node.data('status', status);
        } else {
            // Add new
            cy.add({ group: 'nodes', data: { id: name, description: desc, status: status } });
        }

        // Handle dependency (one field edit)
        if (parent && cy.getElementById(parent).length > 0 && parent !== name) {
            // Remove old edges if changing dependency
            cy.edges(`[target="${name}"]`).remove();
            cy.add({ group: 'edges', data: { source: parent, target: name } });
        }

        persist();
        runLayout();
        resetForm();
    }

    function deleteSelectedNode() {
        if (selectedNodeId && confirm("Delete this project?")) {
            cy.getElementById(selectedNodeId).remove();
            persist();
            resetForm();
        }
    }

    function resetForm() {
        selectedNodeId = null;
        document.getElementById('projName').value = '';
        document.getElementById('projName').disabled = false;
        document.getElementById('projDesc').value = '';
        document.getElementById('projStatus').value = 'not-started';
        document.getElementById('projParent').value = '';
        document.getElementById('formTitle').innerText = "Add Project";
        document.getElementById('editHint').style.display = "none";
        document.getElementById('deleteBtn').style.display = "none";
    }

    function persist() { localStorage.setItem('projectGraphV3', JSON.stringify(cy.elements().jsons())); }
    function clearAll() { if(confirm("Clear all?")) { localStorage.clear(); cy.elements().remove(); resetForm(); } }
</script>

</body>
</html>
