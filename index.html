<!DOCTYPE html>
<html>
<head>
    <title>Project Roadmap Card View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; color: #333; overflow: hidden; }
        #sidebar { width: 340px; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: #f4f7f6; flex-shrink: 0; }
        #cy { flex-grow: 1; height: 100%; background: #eef2f3; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        
        .btn-group { display: flex; gap: 5px; margin-top: 15px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #6c757d; color: white; }
        .btn-delete { background: #dc3545; color: white; margin-top: 10px; width: 100%; display: none; }
        
        #resetZoom { position: absolute; bottom: 20px; right: 20px; background: white; border: 1px solid #ccc; padding: 10px; cursor: pointer; border-radius: 4px; z-index: 10; font-weight: bold; }
        .legend { font-size: 0.8em; margin-top: 20px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        .swatch { display: inline-block; width: 12px; height: 12px; margin-right: 5px; border: 1px solid #999; vertical-align: middle; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 id="formTitle" style="margin-top:0">Project Card</h2>
    <input type="hidden" id="nodeInternalId">

    <div class="input-group">
        <label>Project Name</label>
        <input type="text" id="projName" placeholder="Project Title">
    </div>

    <div class="input-group">
        <label>Description</label>
        <textarea id="projDesc" rows="2" placeholder="Brief summary..."></textarea>
    </div>

    <div class="input-group">
        <label>Status (Card Color)</label>
        <select id="projStatus">
            <option value="not-started">Haven't Started (White)</option>
            <option value="in-progress">In Progress (Yellow)</option>
            <option value="completed">Completed (Green)</option>
        </select>
    </div>

    <div class="input-group">
        <label>Difficulty (1-5)</label>
        <input type="number" id="projDiff" min="1" max="5" value="1">
    </div>

    <div class="input-group">
        <label>To-Do Items (one per line)</label>
        <textarea id="projTodos" rows="4" placeholder="Task 1&#10;Task 2"></textarea>
    </div>

    <div class="input-group">
        <label>Requires (parent names)</label>
        <input type="text" id="projParents" placeholder="Parent A, Parent B">
    </div>

    <div class="btn-group">
        <button class="btn-save" onclick="saveProject()">Apply Changes</button>
        <button class="btn-cancel" onclick="resetForm()">New/Clear</button>
    </div>
    
    <button id="deleteBtn" class="btn-delete" onclick="deleteNode()">Delete Project</button>

    <div class="legend">
        <strong>Status Legend:</strong><br>
        <span class="swatch" style="background:#fff"></span> Not Started<br>
        <span class="swatch" style="background:#fffde7"></span> In Progress<br>
        <span class="swatch" style="background:#e8f5e9"></span> Completed
    </div>
</div>

<button id="resetZoom" onclick="cy.fit()">Zoom to Fit</button>
<div id="cy"></div>

<script>
    let cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            { 
                selector: 'node', 
                style: { 
                    'shape': 'rectangle',
                    'background-color': '#fff',
                    'label': function(ele) {
                        const d = ele.data();
                        const desc = d.description ? `\n"${d.description}"` : "";
                        const diff = `\nDifficulty: ${'★'.repeat(d.difficulty || 1)}`;
                        const todos = d.todos && d.todos.length > 0 
                            ? "\n\nTASKS:\n• " + d.todos.join('\n• ') 
                            : "";
                        return `${d.name.toUpperCase()}${desc}${diff}${todos}`;
                    },
                    'text-wrap': 'wrap',
                    'text-max-width': '200px',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'padding': '15px',
                    'width': 'label',
                    'height': 'label',
                    'border-width': 2,
                    'border-color': '#444',
                    'font-size': '11px',
                    'line-height': 1.4,
                    'text-justification': 'left'
                } 
            },
            { selector: 'node[status="in-progress"]', style: { 'background-color': '#fffde7', 'border-color': '#fbc02d' } },
            { selector: 'node[status="completed"]', style: { 'background-color': '#e8f5e9', 'border-color': '#2e7d32' } },
            { selector: 'edge', style: { 'width': 2, 'line-color': '#999', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#999', 'curve-style': 'taxi', 'taxi-direction': 'vertical' } },
            { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#007bff' } }
        ],
        layout: { name: 'breadthfirst', directed: true }
    });

    const storageKey = 'projectGraphFinal';
    const saved = localStorage.getItem(storageKey);
    if (saved) { cy.add(JSON.parse(saved)); runLayout(); }

    function runLayout() { 
        cy.layout({ name: 'breadthfirst', directed: true, padding: 50, spacingFactor: 1.4 }).run(); 
    }

    cy.on('tap', 'node', function(evt){
        const node = evt.target;
        const data = node.data();
        document.getElementById('nodeInternalId').value = node.id();
        document.getElementById('projName').value = data.name;
        document.getElementById('projDesc').value = data.description || '';
        document.getElementById('projStatus').value = data.status || 'not-started';
        document.getElementById('projDiff').value = data.difficulty || 1;
        document.getElementById('projTodos').value = (data.todos || []).join('\n');
        document.getElementById('projParents').value = node.incomers('edge').sources().map(n => n.data('name')).join(', ');
        
        document.getElementById('formTitle').innerText = "Edit Card";
        document.getElementById('deleteBtn').style.display = "block";
    });

    function saveProject() {
        const internalId = document.getElementById('nodeInternalId').value;
        const name = document.getElementById('projName').value.trim();
        const desc = document.getElementById('projDesc').value.trim();
        const status = document.getElementById('projStatus').value;
        const diff = document.getElementById('projDiff').value;
        const todoText = document.getElementById('projTodos').value;
        const parentsInput = document.getElementById('projParents').value;

        const todoArray = todoText.split('\n').map(t => t.trim()).filter(t => t !== "");
        if (!name) return alert("Enter a name");

        let node;
        if (internalId) {
            node = cy.getElementById(internalId);
            node.data({ name, description: desc, status, difficulty: diff, todos: todoArray });
            cy.edges(`[target="${internalId}"]`).remove();
        } else {
            const newId = 'id' + Date.now();
            node = cy.add({ group: 'nodes', data: { id: newId, name, description: desc, status, difficulty: diff, todos: todoArray } });
        }

        if (parentsInput.trim() !== "") {
            parentsInput.split(',').map(p => p.trim()).forEach(pName => {
                const pNode = cy.nodes().filter(n => n.data('name') === pName);
                if (pNode.length > 0) cy.add({ group: 'edges', data: { source: pNode.id(), target: node.id() } });
            });
        }

        persist();
        runLayout();
        resetForm();
    }

    function resetForm() {
        document.getElementById('nodeInternalId').value = '';
        document.getElementById('projName').value = '';
        document.getElementById('projDesc').value = '';
        document.getElementById('projStatus').value = 'not-started';
        document.getElementById('projDiff').value = 1;
        document.getElementById('projTodos').value = '';
        document.getElementById('projParents').value = '';
        document.getElementById('formTitle').innerText = "Project Card";
        document.getElementById('deleteBtn').style.display = "none";
        cy.nodes().unselect();
    }

    function deleteNode() {
        const id = document.getElementById('nodeInternalId').value;
        if (id && confirm("Delete card?")) { cy.getElementById(id).remove(); persist(); resetForm(); }
    }

    function persist() { localStorage.setItem(storageKey, JSON.stringify(cy.elements().jsons())); }
</script>

</body>
</html>
